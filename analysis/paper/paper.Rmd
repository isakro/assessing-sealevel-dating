---
title: "A simulation-based assessment of the relation between Stone Age sites and relative sea-level change along the Norwegian Skagerrak coast"
author:
  - Isak Roalkvam:
      email: isak.roalkvam@iakh.uio.no
      institute: [UofO]
      correspondence: true
institute:
  - UofO: University of Oslo
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::pdf_document2:
      toc: false
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/",
  dpi = 300
)

knitr::opts_knit$set(
  eval.after = "fig.cap"
)
```

```{r libraries, eval = TRUE, results = 'hide'}
library(here)
library(tidyverse)
library(sf)
library(ggridges)
library(ggthemes)
library(ggnewscale)
library(patchwork)
library(terra)
library(raster)
library(oxcAAR)
library(vapour)
library(topoDistance)
library(IRanges)
quickSetupOxcal()
```

```{r get-data-functions, include = FALSE}
# Load all sites and radiocarbon data
sites <- read.csv(here('analysis/data/raw_data/sites.csv'))
rcarbon <- read.csv(here('analysis/data/raw_data/radiocarbon.csv'))

# Background map
bmap <- st_read(here('analysis/data/raw_data/naturalearth_countries.gpkg'))

# Digital terrain model
dtm <- rast("/home/isak/phd/eaa_presentation/dtm10/dtm10.tif")

# Load processed site and radiocarbon data, and load functions
load(here("analysis/data/derived_data/01data.RData"))
load(here("analysis/data/derived_data/02data.RData"))
load(here("analysis/data/derived_data/06data.RData"))
source(here("analysis/script/04script.R"), local = knitr::knit_global())

# Exclude Lunaveien and Dybdalshei 2 (See supplementary material)
sites_sa <- filter(sites_sa, !(name %in% c("Dybdalshei 2", "Lunaveien")))

```

# Introduction

The post-glacial relative sea-level fall that characterises large areas of Fennoscandia is fundamental to its archaeology. This follows not only from the dramatic changes to the landscape that this process has represented throughout prehistory, but also from the fact that if archaeological phenomena were situated close to the contemporary shoreline when they were in use, a reconstruction of the trajectory of shoreline displacement can be used to date these phenomena based on their altitude relative to the present day sea-level. This method, also called shoreline dating, has long history of use in the region and is frequently applied to assign an approximate date to diverse archaeological phenomena such as rock art, grave cairns, various harbour and sea-side constructions and, as is the focus of this study, Stone Age sites [e.g. @berg-hansen2009; @bjerck2005; @sognnes2003; @solheim2018; @tallavaara2020].

The close association between Norwegian Stone Age sites located in coastal regions and prehistoric shorelines was firmly established by the geologist W.C. Brøgger in 1905 (see the review by @maccurdy1906 for an early mention in English). Shoreline dating has been fundamental to Stone Age research in Norway ever since [e.g. @berg-hansen2009; @bjerck1990; @mjærum2018]. The method is used both independently and to compliment the dating of sites where other sources of temporal data such as typological indicators or radiometric dates are either limited or not available. Given the coarse and fuzzy resolution of established typological frameworks, the vast amount of surveyed sites that only contain generic lithic debitage that could hail from any part of the period, and as the conditions for the preservation of organic material is typically poor in Norway, dating with reference to shoreline displacement is often the only and most accurate method by which one can hope to date the sites. Shoreline dating is consequently fundamental to our understanding of the Norwegian Stone Age. This is both because it is fundamental to the temporal framework on which our understanding of the period is based, but also because the method is only applicable so long as the societies in question have continuously settled on or close to the contemporary shoreline. Consequently, adherence or deviation from this pattern also has major implications for the socio-economic foundations of the societies in question.

Despite its fundamental role for Norwegian Stone Age archaeology, the applicability of dating by reference to shoreline displacement has only been evaluated using relatively coarse methods. The aim of this paper is to provide a systematic and comprehensive review of the degree to which radiocarbon dates correspond with the dates informed by our current knowledge of shoreline displacement in a larger area of south-eastern Norway, using a more refined methodological approach. The goal is to quantify the degree to which the assumption of shore-bound settlement holds through the Stone Age. As presented in more detail below, this problem involves the combined evaluation of three major analytical dimensions. One is the questions of when the sites were in use, the second pertains to the reconstruction of the contemporaneous sea-level, and the third follows from the fact that the relation between site and shoreline is inherently spatial. Taking inspiration from recent studies that have integrated various sources of spatio-temporal uncertainty through Monte Carlo simulation [e.g. @crema2012; @crema2010; @lewis2021], a similar approach is adopted here.

# Background

Relative sea-level (RSL) can be defined as the mean elevation of the surface of the sea relative to land, or, more formally, the difference in elevation between the geoid and the surface of the Earth as measured from the Earth's centre [@shennan2015]. Variation in this relative distance follow from a range of effects [e.g. @milne2009; @mörner1976]. Of central importance here is eustasy and glacial istostasy. The eustatic sea-level is understood as the sea-level if the water has been evenly distributed across the Earth's surface without adjusting for variation in the rigidity of the Earth, its rotation, or the self-gravitation inherent to the water body itself [@shennan2015]. The eustatic sea-level is mainly impacted by glaciation and de-glaciation, which can bind or release large amounts of water into the oceans, as well as by changes in the Earth's crust that impact the volume of ocean basins. Istostasy, on the other hand, pertains to adjustments in the crust to regain gravitational equilibrium relative to the underlying viscous mantle. This is often the result of glacial istostasy, which follows from glaciation and de-glaciation and corresponding loading and unloading of weight, as well as from erosion of the crust, which causes its weight to be redistributed. These effects thus causes the lithosphere to either subside due to increased weight, or to rebound and lift upwards due to lower weight [@milne2015].

Following the end of the Weichselian and the final retreat of the Fennoscandian Ice Sheet [e.g. @hughes2016; @stroeven2016], the isostatic rebound has been so severe that most areas of Norway have been subject to a continuous relative sea-level regression, despite corresponding eustatic sea-level rise [e.g. @lambeck1998; @svendsen1987]. In other words, the RSL has been dropping throughout prehistory. As this process is the result of glacial loading, the rate of uplift is more severe towards the centre of the ice sheet. Thus, some areas on the outer coast have had a more stable RSL or been subject to marine transgression [e.g. @romundset2015; @svendsen1987]. These conditions are directly reflected in the archaeological record. In areas where the sea-level has been stable over longer periods of time, people have often reused coastal site locations multiple times and over long time-spans, creating a mix of settlement events that are difficult to disentangle [@reitan2009]. Transgression phases, on the other hand, can lead to complete destruction of the sites, or bury them in marine sediments, leading to a hiatus in the archaeological record for certain sub-phases in the impacted areas [@bjerck2008]. Comparatively, given a continuous and still ongoing shoreline regression from as high as c. 220 m above present sea-level in the inner Oslo fjord, any one location in south-eastern Norway has only been shore-bound within a relatively limited time-span, and the sites have not been impacted by any transgressions [@hafsten1957; @hafsten1983; @sørensen1979]. This makes the region especially useful for evaluating the assumption of a shore-bound settlement over a long and continuous time-span.

```{r deglaciation, echo = FALSE, fig.cap = "Deglaciation at 1000 year intervals from c. 17--8 kyr BCE (data from Hughes et al. 2016). The study area defined later in the text is marked with a red outline.", out.width = "400px", fig.align="center"}

knitr::include_graphics(here("analysis/figures/deglaciation.png"))

```

The shore-bound settlement location of prehistoric hunter-fisher-gatherers in Norway is generally believed to follow both from the exploitation of aquatic resources and from movement and communication, which would have been efficient on waterways. The same logic has also been extended to the hinter- and inland regions, where sites are to be located along rivers and lakes. This is to take a dramatic turn at the transition to the Late Neolithic, around 2400 BCE, with the introduction of the Neolithic proper. associated involving a change agro-pastoralism, the farm,  means that the site locations are now more withdrawn from the shoreline [@solheim2018; @prescott2012]. That is not to say that waterways and aquatic resources were no longer exploited, but rather that these activities would not have been as tightly integrated with settlement and tool-production areas as in preceding periods. Earlier, at the transition to the Early Neolithic (c. 4000 BCE) pottery is introduced to the sites, and there are some possible indications of an initial, small-scale uptake of agriculture at some sites in the Oslo fjord region. However, this initial uptake appears to be relatively small-scale and is believed to be combined with a continued and predominantly hunter-gatherer life-way, followed by a de-Neolithisation in the Middle Neolithic. [@nielsen2021] has recently argued that while there, the initial uptake of in the Early Neolithic is combined with a more complex settlement pattern, and argues that the simple forager/farming dichotomy has underplayed the variation present in the Early and Middle Neolithic data. The empirical expectation for this development would thus be a more varied relation between sites and the shore-line.

Based on the generally accepted premise that most pre-Late Neolithic sites in south-eastern Norway located lower than the marine limit were situated on or close to the contemporaneous shoreline, it is common to err on the side of a shore-bound site location unless there is strong evidence to suggest otherwise. This is for example common in survey projects, which are often guided by a both a digital and mental reconstruction of past sea-levels. Similarly, following an excavation, if typological indicators in the assemblages correspond with available shoreline displacement curves it is common to assume a shore-bound site location, even if the typologically informed date-span is too wide to decisively verify this. It is also common to combine this with a qualitative consideration of the landscape surrounding the sites, and an evaluation of the degree to which the site location would have been sensible if the site was not shore bound [e.g. @jaksland2014; @nummedal1923]. This can for example pertain to accessibility. If the site is situated on a ledge in a steep and jagged area of the present day landscape, or if it would have been located on an island when the sea-level was higher, it would make intuitive sense that the site was in use when the ocean reached closer to its elevation, as the site would have been accessible by means of watercraft. Although it appears that the arguments for such site locations are sensible and can for the most part be assumed to hold, comprehensive evaluations and attempts at quantification of this tendency are few, and are typically conducted on a site-by-site or project-by-project basis, meaning the fundamental basis for assuming shore-bound site location is largely based on a mosaic of smaller scale investigations.

One of the more comprehensive evaluations of this relationship was done by Solheim and colleagues (@breivik2018; @solheim2020), who compared 102 ^14^C-dates from 29 Mesolithic sites on the western side of the Oslo fjord to the displacement curve for the Larvik area. They found an overlap between the probability distribution of the radiocarbon dates with the shoreline displacement curve for 86.5% of the sites. However, where there was a discrepancy, the main occupation of the sites are still believed to have been shore-bound rather than associated with the deviating ^14^C-dates. This is based on typological and technological characteristics of the assemblages. Whether these mismatches represent later shorter visits that are responsible for the younger radiocarbon dates, or whether these are entirely erroneous results of contamination can be difficult to evaluate. Here this will be entirely dependent on, and follow the discretion of the original excavation reports.

Other previous evaluations of the correspondence between dates informed by radiocarbon dates and shoreline dating have typically followed the same structure as that of @breivik2018, involving a visual inspection of radiocarbon probability distributions plotted against local shoreline displacement curves based on the elevation of the site [e.g. @åstveit2018; @solheim2020]. This approach has a couple of limitations. First of all, the displacement curves are commonly applied directly to larger study areas, with only a couple of studies having taken the variable uplift-rates into account when performing this comparison [e.g. @fossum2020; @møller1987; @persson2008]. Secondly, with this method, the wider the uncertainty range associated with either radiocarbon date or displacement curve, the higher the probability that the confidence intervals overlap, and the higher the probability that we conclude in favour of our hypothesis. This thus leads to an inferential framework that favours uncertainty, which is hardly desirable. In statistical terms this follows from the fact that while one cannot conclude that two dates are different if their confidence intervals overlap, this does not necessarily mean that they are the same. The question thus necessitates a flip from a null-hypothesis of no significant difference, to one of equivalence [e.g. @lakens2018], as the question of interest is effectively one of synchroneity between events [cf. @parnell2008]. Another limitation of this often-employed method is that it only takes into account the vertical distance between the sites and the sea-level. While this is the main parameter of interest for shoreline dating, the practical implications of a vertical difference in RSL will be highly dependent on local topography and bathymetry. RSL-change can have more dramatic consequences in a landscape characterised by a low relief, as the horizontal displacement of the shoreline will be greater. Taking the spatial nature of the relationship between site and shoreline into account will consequently help get more directly at the behavioural dimension of this relation, and move the analysis beyond a purely instrumental consideration of the applicability of shoreline dating. Suggested ways to help mitigate and integrate the issues presented above into to the analysis are presented in the methods section.

# Data

All data and R programming code [@rcoreteam2021] required to run the analyses, as well as the derived data are freely available in an online repository at <https://osf.io/7f9su/>, organised as a digital research compendium following @marwick2018. The dataset is slightly more extensive than what is directly utilised in the study, and includes excavated sites without ^14^C-dates within the study area, as well as ^14^C-dates to periods other than the Stone Age.

To get at the relationship between sites and the contemporaneous shoreline, the analysis is dependent on a study area with good control of the trajectory of prehistoric shoreline displacement. While there is displacement data available for other areas of south-eastern Norway [e.g. @hafsten1957; @sørensen1979; @sørensen1999], considerable methodological developments in recent years means that the most well-established displacement curves are from the region stretching from Horten county in the north-east, to Arendal in the south-west. This area has newly compiled displacement curves for Horten [@romundset2021], Larvik [@sørensen2014; @sørensen2014b], Tvedestrand [@romundset2018; @romundset2018b], and Arendal [@romundset2018b].

The employed shoreline displacement curves are all based on the so-called isolation basin method [@romundset2011]. This involves extracting cores from a series of basins situated on bedrock at different elevations beneath the marine limit, and dating the transition from marine to lacustrine sediments in the cores. Each curve is thus construed from a series of cored basins located at different elevations, each representing a high precision sea-level index point. Furthermore, to minimise the impact of variable uplift rates, the basins are located in a as constrained area of the landscape as possible. Following from the morphology of the retreating ice sheet, the uplift is more severe towards the north-east, meaning that this needs to be adjusted for in the case that any basins are located a significant distance from a common isobase perpendicular to this gradient. The confidence bands of the displacement curves and their trajectory are quite complex constructs, and are the integrated result of both expert knowledge and more objectively quantifiable parameters. The reason for this is in part that the curves do not only contain uncertainty as related to radiometric dates, which are well defined, but also hold potential error as related to the interpretation and analysis of sediment cores, the nature and condition of the basin outlets, the adjustment to a common isobase, to name but a few [e.g. @romundset2011; @romundset2019]. For more details and evaluations done for the compilation of each curve, the reader is therefore referred to the individual publications (see above).

The archaeological data compiled for the analysis consists of all excavated Stone Age sites with available spatial data from the coastal region between Horten county in the north-east, to Arendal in the south-west (Figure \@ref(fig:map-iso)). These number a total `r nrow(sites)` sites. Of these, `r length(unique(rcarbon$site_name))` sites are associated with the total of `r nrow(rcarbon)` radiocarbon dates. In turn, `r nrow(sites_sa)` sites are related to the `r nrow(rcarb_sa)` radiocarbon dates that fall within the Stone Age (9500--1700 BCE) with 95 % probability. These sites and ^14^C-dates form the basis for the analysis. Spatial data in the form of site limits and features, as defined by the excavating archaeologists, were retrieved from local databases at the Museum of Cultural History---the institution responsible for archaeological excavations in the region. In the compiled dataset, each radiocarbon date has been associated with the site features or excavation unit from where they originate, or, where these weren't available, the spatial limit of the entire site. Due to somewhat variable practices between excavations, what available spatial geometry best represents the site limit was decided based on an evaluation of the excavation reports. This means that the limits are variably given as that defined during initial survey, area de-turfed before excavation, area stripped with excavator following the excavation, manually excavated area, or convex hull polygons generated around the site features.

Five of the sites have been associated with farming activities, either in directly or in the form building structures. The first is Nordby 1, which has . The Middle Neolithic phase at Kvastad A2 and Late Neolithic phase at Nauen A are related to farming. Both sites also have ^14^C-dates and lithic inventory associated with Mesolithic forager activities. Finally, @nielsen2021 has recently suggested that Early and Middle Neolithic features from the otherwise younger sites Bratberg and Lang could be related to early agricultural activity in the Oslo fjord region.


[Table with sites]

The elevation data used for the analysis is a digital terrain model (DTM) freely available from the Norwegian Mapping Authority [@mapping2019]. After evaluating the options I opted for the 10m resolution DTM rather than the higher-resolution 1m version. In addition to resulting in considerably less processing time, the higher resolution elevation model is more vulnerable to smaller-scale modern disturbances that the 10m version is not impacted by. The 10m DTM is a down-sampled version of the 1m resolution DTM, which is based on aerial laser scanning using a minimum of two and up to five points per m^2^ [@mapping2019].  

```{r map-iso,  fig.cap = paste("A) Distribution of the ", nrow(sites_sa), " analysed sites relative to the isobases of the displacement curves. The isobases have a direction of 327$^{\\circ}$ (Romundset et al. 2018), B) Displacement curves. Note the increasing steepness of the curves towards the north-east."), fig.height = 13}
bboxsites <- st_bbox(sites_sa)
bboxsites[1] <- bboxsites[1] - 15000
bboxsites[3] <- bboxsites[3] + 15000
bboxsites[2] <- bboxsites[2] - 5000
bboxsites[4] <- bboxsites[4] + 5000
bboxsitespoly <- st_as_sf(st_as_sfc(bboxsites))

bound_reproj <- st_transform(bboxsitespoly, st_crs(bmap))
bmap2 <- bmap %>%
    filter(st_intersects(., bound_reproj, sparse = FALSE))
bmap_reproj <- st_transform(bmap2, st_crs(sites_sa))

anc <- as.numeric(c(bboxsites$ymin, bboxsites$xmax))
overview_map <- ggplot() +
  geom_sf(data = bmap_reproj, fill = "grey", colour = NA) +
  geom_sf(data = isobases, aes(colour = name)) +
  geom_sf(data = st_centroid(sites_sa), fill = "red",
          size = 2.25, shape = 21,
          colour = "black") +
  ggsn::scalebar(data = sites_sa, dist = 20, dist_unit = "km",
                 transform = FALSE, st.size = 4, height = 0.02,
                 border.size = 0.1, st.dist = 0.03,
                 anchor = c(x = anc[2] - 15500, y = anc[1]) + 8000) +
  coord_sf(xlim = c(bboxsites[1], bboxsites[3]),
           ylim = c(bboxsites[2], bboxsites[4]),
           expand = FALSE) +
  scale_colour_manual(values = c("Arendal" = "black",
                                   "Larvik" = "darkgreen",
                                   "Tvedestrand" = "blue",
                                   "Horten" = "darkorange")) +
  theme_bw() + theme(axis.title=element_blank(),
                     axis.text.y = element_blank(),
                     axis.text.x = element_blank(),
                     rect = element_rect(),
                     axis.ticks = element_blank(),
                     panel.grid.major = element_blank(),
                     legend.position = "none") 

disp_curves <- ggplot(displacement_curves, aes(x = years, col = name)) +
  geom_line(aes(y =  upperelev)) +
  geom_line(aes(y = lowerelev)) +
  ylab("Meters above present sea-level") +
  xlab("cal BCE/CE") +
  scale_colour_manual(values = c("Arendal" = "black",
                                   "Larvik" = "darkgreen",
                                   "Tvedestrand" = "blue",
                                   "Horten" = "darkorange")) +
  theme_bw() +
  theme(legend.title = element_blank(), legend.position = "bottom",
        legend.direction = "horizontal")


overview_map / disp_curves
```

# Methods

The goal of this study is effectively to evaluate the spatial relationship between two phenomena, sites and shorelines, each associated with their own range of temporal uncertainty. The first task was therefore to ascribe likely date ranges and associated uncertainty to the two phenomena.

To take account of the gradient in the isostatic rebound, the shoreline displacement curves were adjusted to each site location by taking into account the distance to the closest isobase. This was done for each site by first finding the difference between the elevation values of the two closest displacement curves for each year along the entirety of the curves. Each value was then divided by the distance between the isobases. To find the adjusted displacement curve for a given site location, the distance between the site polygon and closest isobase was multiplied with the values for difference per meter. These values were then subtracted from the displacement curve located to the south-west of the site, and in the few cases where the site was located south-west of all isobases, the values were instead added. The result of this process is shown for an example site in Figure \@ref(fig:example-1).

For the date ranges associated with the sites, all radiocarbon dates were first individually calibrated using the IntCal20 calibration curve [@reimer2020] using OxCal v4.4.4 [@bronkramsey2009] through the oxcAAR package for R [@hinz2021]. Radiocarbon dates associated with each site were then grouped if they overlapped with 99.7 % probability, meaning these were effectively taken to represent the same settlement phase. In the case where there are multiple dates believed to belong to a single phase, these were subjected to Bayesian modelling using the Boundary function in OxCal and then summed. Multiple phases at a single site were treated as independent of each other.

As the excavation of archaeological sites typically follow from residential and commercial development, as well as the expansion of infrastructure, the area immediately surrounding the sites have sometimes been severely impacted by modern disturbances. In addition to employing 10m resolution DTM to alleviate some of these issues, this also necessitated some additional editing of the elevation raster. This involved manually defining the extent of problem areas such as railways, highways, quarries and the like. The DTM values on these were then set to missing, and new elevation values were interpolated from the surrounding terrain. This was done using regularised spline interpolation with tension [e.g. @conolly2020], using the default settings of r.fillnulls from GRASS GIS in R through the package rgrass7 [@bivand2021]. In addition to code and original spatial data being available in the research compendium for this paper, it has also been noted in the supplementary material when the area surrounding a site has been edited in this manner.

Armed with a likely date range for the occupation(s) of each site, an estimated trajectory of relative sea-level change at that location, and a DTM edited to remove substantial modern disturbances, the simulations were performed. A single simulation run involved first drawing a single year from the posterior density estimate of a given occupation phase of a site (Figure \@ref(fig:example-2)). This year then has a corresponding likely elevation range for the contemporaneous shoreline from which an elevation value was drawn uniformly, using intervals of 5cm. The sea-level was then raised to this elevation on the DTM by defining all elevation values at or below this altitude as missing. Polygons were then created from the resulting areas with missing values. The horizontal distance was then found by measuring the shortest distance between site and sea polygons, and the vertical distance by subtracting the elevation of the sea-level from the lowest elevation of the site polygon. The topographic distance between site and sea was also found by measuring the shortest distance while taking into account the slope of the terrain on the DTM. This was done using the topoDistance package for R [@wang2019]. The topographic distance was measured between site polygon and the horizontally closest point on the shoreline. This means that the distance is not necessarily measured as the closest topographic distance to the shoreline, but rather as the shortest topographic path to the horizontally closest point on the shoreline. Not finding the topographically closest point significantly reduced the computational cost of the analysis, and is deemed unlikely to have a considerable impact on the results, given the distances considered. The shortest topographic path was found using the Queen's pattern neighbourhood of eight cells [@conolly2006]. In the case where the sea-polygons intersects the site polygon, all distance measures were set to zero. In the case that the sea-polygon completely contain the site, the horizontal and topographic distance measures were made negative, and the vertical distance was instead measured to the highest point on the site polygon. While it is safe to assume that an archaeological site was not occupied when it was located beneath sea-level, a negative result can reflect the inherent uncertainty in this procedure, and might also help identify discrepancies in displacement data or radiocarbon dates. Negative values were therefore retained, with the exception of for the sites Gunnarsrød 5, Pjonkerød R1 and , where the negative values are believed to result from modern disturbances in the DTM rather than the ^14^C-dates or displacement curves (see supplementary material for more details).

This process was repeated 1000 times for each phase for each site. The choice of 1000 simulation runs follows from an evaluation of when the mean distances between site and shoreline converged when running 5000 iterations of the simulation on the site Hovland 5. Hovland 5 was chosen for this evaluation as it has a fairly uncertain date range, and is located in area of quite complex topography. At 1000 simulation runs the analysis of each site ranged from taking a few hours to a couple of days, depending on the distance to the simulated shorelines and the necessary size of the window of analysis.

```{r example-site, fig.show='hide'}

# Assign closest isobases to site data.
sites_sa <- st_join(st_make_valid(sites_sa), isopolys,
                    join = st_intersects, largest = TRUE)

# Specify site name
sitename <- "Hegna vest 1"

# Group dates that overlap with 99.7 % probability using the group_dates()
# function. All functions in this chunk where package isnt specified are defined 
# in 04script.R
date_groups <- group_dates(rcarb_sa, sitename)

# Retrieve site limit and site features
siter <- dplyr::filter(rcarb_sa, site_name == sitename)
sitel <- dplyr::filter(sites_sa, name == sitename)

# Creating bounding box at 400 meters
location_bbox <- bboxpoly(sitel, 400)

# Clip DTM with the bbox
sitearea <- terra::crop(dtm, location_bbox)

# Model dates using the Boundary function
datedat <- model_dates(sitedates = siter, date_groups = date_groups)

# Find local displacement curve
sitecurve <- interpolate_curve(years = xvals,
                                 isobase1 = sitel$isobase1,
                                 isobase2 = sitel$isobase2,
                                 target = sitel,
                                 dispdat = displacement_curves,
                                 isodat = isobases,
                                 direction_rel_curve1 = sitel$dir_rel_1)
# Add site name
sitecurve$name <- sitename

# Plot of dates
date_plot <- plot_dates(datedat, sitename, title = FALSE)
site_map <- site_plot(sitearea, sitel, 150, date_groups,
                      s_tdist = 0.5, s_xpos = 175,
                       s_ypos = 85,  s_bheight = 0.3, s_tsize = 3)
overview_map <- overview_plot(bmap, sitel, sites_sa, isobases,
                               os_tdist = 0.03, os_xpos = 20000, os_ypos = 8000,
                               os_bheight = 0.02, os_tsize = 3)

dispdata <- filter(displacement_curves, name %in% c("Larvik", "Tvedestrand"))

curve_plot <- ggplot() + 
              geom_line(data = dispdata, 
                        aes(x = years, y = upperelev, col = name)) +
  geom_line(data = dispdata, 
                        aes(x = years, y = lowerelev, col = name)) +
  geom_line(data = sitecurve,
            aes(x = years, y = upperelev, col = name)) +
  geom_line(data = sitecurve,
            aes(x = years, y = lowerelev, col = name)) +
  scale_colour_manual(values = c("Larvik" = "darkgreen",
                                  "Tvedestrand" = "blue",
                                 "Hegna vest 1" = "red")) +
  ylab("Meters above present sea-level") +
  xlab("cal BCE/CE") +
  theme_bw() +
  theme(legend.title = element_blank(), legend.position = "bottom",
        legend.direction = "horizontal")


plt <- (site_map + date_plot) /
(overview_map + curve_plot) +
  plot_annotation(tag_levels = 'A')

# It was easier to get correct dimensions by saving and then 
ggsave(file = here("analysis/figures/example_map.png"), plot = plt, width = 250,
       height = 76 + (76 * length(unique(date_groups))),
       units = "mm")

```

```{r example-1, echo = FALSE, fig.cap = "Example site Hegna vest 1 (Fossum 2017). A) Location of the site in the present day landscape. The red outline is the site limit. B) Radiocarbon dates associated with the site. Fill colour indicates what dates are assumed to belong to the same settlement phase. Multiple dates are modelled using the Boundary function in OxCal and then summed. The red outline indicates that the date does not match the typological indicators in the artefact assemblage of the site. C) The location of the site within the study area relative to isobases of the employed displacement curves. D) Displacement curve interpolated to the site location based on the distance between the site and the isobases of the two closest displacement curves.", out.width = "500px", fig.align="center"}
knitr::include_graphics(here("analysis/figures/example_map.png"))
```

```{r example-site-cont2, fig.show='hide'}
set.seed(1)

# Retrieve example date to be used. The posterior sum of date group 1
posteriorprobs <- filter(datedat, group == 1 & class == "sum")

# Set up to sample a single year
samplingframe <- list(x = posteriorprobs[["dates"]],
                      y = posteriorprobs[["probabilities"]])

# Draw a single year
sdate <- round(with(samplingframe, sample(x, size = 1, prob = y)))

# Create plot showing the year drawn from the posterior sum
datsamp <- ggplot(posteriorprobs) +
  ggridges::geom_ridgeline(aes(x = dates, y = name,
                               height = probabilities * 50),
                           fill = "lightgrey") +
  # Create segment to indicate which year was drawn
  geom_segment(aes(x = sdate, xend = sdate, y = as.numeric(as.factor(name)),
                   yend = as.numeric(as.factor(name)) +
                     (posteriorprobs[round(dates) == sdate,
                                     "probabilities"]) * 50),
               colour = "red") +
  labs(x = "cal BCE")  +
  #scale_y_discrete(expand = c(0.01, 0)) +
  theme_bw() + theme(
    legend.position = "none",
    axis.line = element_line("black"),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank()
  ) +
  scale_x_continuous(breaks = sort(c(-8200, -8000, sdate, -7600)))

# Find upper and lower shoreline elevation at sdate
uppers <- round(approx(sitecurve[,"years"], sitecurve[,"upperelev"],
                       xout = sdate)[["y"]], 1)
lowers <- round(approx(sitecurve[,"years"], sitecurve[,"lowerelev"],
                       xout = sdate)[["y"]], 1)

# Draw sea-level uniformly from elevation range, intervals of 5 cm
sealevel <- sample(seq(lowers, uppers, 0.05), 1)

# Plot the drawn elevation on the displacement curve
elevsamp <- ggplot(sitecurve, aes(x = years)) +
  geom_line(aes(y =  upperelev), colour = "red") +
  geom_line(aes(y = lowerelev), colour = "red") +
  ylab("Meters above present sea-level") +
  xlab("cal BCE/CE") +
  theme_bw() +
  theme(legend.title = element_blank(), legend.position = "bottom",
        legend.direction = "horizontal") +
  geom_segment(aes(x = sdate, xend = sdate, y = uppers,
                                           yend = -Inf), col = "black",
                size = 0.25, linetype = "solid") +
  geom_segment(aes(x = -Inf, xend = sdate, y = uppers,
                   yend = uppers), col = "black", size = 0.25) +
  geom_segment(aes(x = -Inf, xend = sdate, y = lowers,
                   yend = lowers), col = "black", size = 0.25) +
  geom_segment(aes(x = -Inf, xend = sdate, y = lowers,
                   yend = lowers), col = "black", size = 0.25) +
  geom_segment(aes(x = -Inf, xend = sdate, y = sealevel,
                   yend = sealevel), col = "red", size = 0.25,
               linetype = "dashed") +
  annotate("text", x = -8700, y = uppers + 3.5, label = as.character(uppers)) +
  annotate("text", x = -8700, y = lowers - 3.5, label = as.character(lowers)) +
  scale_x_continuous(breaks = sort(c(sdate, -6000, -3000, 0))) +
  scale_y_continuous(breaks = sort(c(0, sealevel, 100)))

# Adjust sea-level on DTM
rclmat <- matrix(c(sealevel, Inf, NA, 0, sealevel, 1),
                 ncol = 3, byrow = TRUE)
classarea <- terra::classify(sitearea, rclmat)
seapoly <- st_combine(st_as_sf(terra::as.polygons(classarea)))


# Retrieve lowest elevation on polygon
siteelev <- extract(sitearea, vect(sitel), fun = min)[2]
# Find difference to sea-level elevation
vertdist <-  min(siteelev[1:nrow(siteelev),]) - sealevel

# Find the nearest points on the site- and seapolygons,
distline <- st_nearest_points(sitel, seapoly)

# Retrieve the two points
distpts <- st_cast(distline, "POINT")

# Find topographic distance
coords <- rbind(st_coordinates(distpts[1]),
                st_coordinates(distpts[2]))
rownames(coords) <- c("loc", "sea")

# Find topographic distance (retrieve path)
topodist <- topoDist(raster::raster(sitearea), coords,
                     paths = TRUE)
# Store distance
tdist <- topodist[[1]]["loc", "sea"]

# Retrieve path
tpath <- st_as_sf(topodist[[2]])

# Find end-points
endptns <- st_line_sample(tpath, sample = c(0, 1))

# Cast as line
hordistl <- st_cast(endptns, "LINESTRING")

# Find horizontal distance
hordist <- st_length(hordistl)

# Create hillshade
# For some reason the terra version returned pathchy hillshade (probably due 
# to the defaults - I didn't bother experimenting too much as this is simply for
# the purposes of visualisation).
slope <- raster::terrain(raster(sitearea), 'slope')
aspect <- raster::terrain(raster(sitearea), 'aspect')
hill <- raster::hillShade(slope, aspect, 40, 270)

# Make the raster amenable for plotting with ggplot (as.data.frame with terra
# returned some strange errors)
raster_df <- raster::as.data.frame(raster(sitearea), xy = TRUE)
names(raster_df) <- c("x", "y", "value")

# Anchor for scale bar
anc <- as.numeric(c(st_bbox(location_bbox)$ymin, st_bbox(location_bbox)$xmax))

# Create plot showing single simulation of sea-level
seasamp <- ggplot() +
  geom_raster(data = raster::as.data.frame(hill, xy = TRUE),
                aes(x = x, y = y, fill = layer)) +
  scale_fill_gradient(low = "black", high = "grey40", na.value = NA) +
  new_scale_fill() +
  geom_raster(data = raster_df, aes(x = x, y = y, fill = value),
                alpha = 0.3) +
  scale_fill_gradient(low = "grey", high = "white", na.value = NA) +
  new_scale_fill() +
  geom_raster(data = raster_df, aes(x = x, y = y, fill = value)) +
  scale_fill_gradient(low = NA, high = NA, na.value = "white") +
  geom_sf(data = seapoly, fill = "#dbe3f3", colour = NA) +
  geom_sf(data = sitel, fill = NA, colour = "red") +
  #labs(title =  paste0("Sea-level at ", sealevel, " m above present")) +
  coord_sf(xlim = c(st_bbox(location_bbox)[1], st_bbox(location_bbox)[3]),
           ylim = c(st_bbox(location_bbox)[2], st_bbox(location_bbox)[4]),
           expand = FALSE) +
  ggsn::scalebar(data = sitel, dist = 150, dist_unit = "m",
                 transform = FALSE, st.size = 3, height = 0.3,
                 border.size = 0.1, st.dist = 0.5,
                 anchor = c(x = anc[2] - 500, y = anc[1] + 800)) +
  theme_bw() + theme(axis.title=element_blank(),
                     axis.text.y = element_blank(),
                     axis.text.x = element_blank(),
                     rect = element_rect(),
                     axis.ticks = element_blank(),
                     panel.grid.major = element_blank(),
                     legend.position = "none")

# Create label of distance measures
dist_label <- paste0("Horizontal distance = ", round(hordist, 1), "m", 
                "\nTopographic distance = ", round(tdist, 1), "m",
                "\nVertical distance = ", round(vertdist, 1), "m")

anot <- ggplot() +
  theme_void() +
  annotate("text", x = 0,  y = 0, label = dist_label,
           hjust = 0.5, size = 7)

simplot <- (datsamp + elevsamp) / 
  (seasamp + anot) + plot_annotation(tag_levels = 'A')

ggsave(file = here("analysis/figures/example_sim_map.png"), plot = simplot, 
       width = 300, height = 76 + (76 * 2),
       units = "mm")

```

```{r example-2, echo = FALSE, fig.cap = "Example of a single simulation run on the site Hegna vest 1. A) The simulation starts by drawing a single year from the posterior density esimate.  B) This then corresponds to an elevation range on the interpolated displacement curve. A single elevation is drawn uniformly from this range using 5cm intervals. C) The sea-level is then adjusted on the DTM to this elevation and the various distance mesaures are found. D) The numerical result of the simulation run.", out.width = "500px", fig.align="center"}
knitr::include_graphics(here("analysis/figures/example_sim_map.png"))
```

```{r example-site-cont3}
# Load results from running 1000 simulations
load(here("analysis/data/derived_data/hegnavest1.RData"))

dat1 <- datsamp <- ggplot(posteriorprobs) +
  ggridges::geom_ridgeline(aes(x = dates, y = name,
                               height = probabilities * 50),
                           fill = "lightgrey") +
  labs(x = "")  +
  #scale_y_discrete(expand = c(0.01, 0)) +
  theme_bw() + theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank()
  ) 

# Map of simulated sea-levels, date group 1
simsea_plot1 <- shore_plot(sitearea, output[[1]]$simsea, sitel, 150, date_groups,
                      s_tdist = 0.5, s_xpos = 1300, s_ypos = 800,
                      s_bheight = 0.3, s_tsize = 3)

# Boxplot of distances from site to sea, date group 1
simdist_plot1 <- distance_plot(output[[1]]$results)


# Retrieve date group 2
probsdat2 <- filter(datedat, group == 2 & class == "bposterior")

dat2 <- ggplot(probsdat2) +
  ggridges::geom_ridgeline(aes(x = dates, y = name,
                                   height = probabilities * 50,
                                   fill = as.factor(group),
                                   alpha = class,
                                   colour = as.factor(rcarb_cor))) +
  labs(x = "cal BCE")  +
  #scale_y_discrete(expand = c(0.01, 0)) +
  theme_bw() + theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank()
  ) +
      scale_colour_manual(breaks = c("f", "t", NA),
                         values = c("red", "black", "yellow")) +
      scale_alpha_manual(values = c("aprior" = 0.05,
                                    "bposterior" = 0.4,
                                    "sum" = 1)) +
  scale_fill_manual(
      values = as.character(ggthemes_data$colorblind[2, 2]))



# Plot of date group 2

# Map of simulated sea-levels, date group 2
simsea_plot2 <- shore_plot(sitearea, output[[2]]$simsea, sitel, 150, date_groups,
                      s_tdist = 0.5, s_xpos = 1300, s_ypos = 800,
                      s_bheight = 0.3, s_tsize = 3)

# Boxplot of distances from site to sea
simdist_plot2 <- distance_plot(output[[2]]$results)

simresultplot <- (dat1 + simsea_plot1 + simdist_plot1) /
(dat2 + simsea_plot2 + simdist_plot2) 

ggsave(file = here("analysis/figures/example_sim_result.png"),
       plot = simresultplot,  width = 250, height = 76 + (76 * 2),
       units = "mm")

```

```{r example-3, echo = FALSE, fig.cap = "The result of 1000 simulation runs for each of the two groups of dates on the site Hegna vest 1. The first column of plots shows the radiocarbon probability density estimate from where dates were drawn during simulation. The second column displays the result of simulating the raised sea-level 1000 times. The more opaque the colour, the more times the sea-level was simulated to that location. The third column shows violin plots of the different distance measures across all simulations.", out.width = "500px"}
knitr::include_graphics(here("analysis/figures/example_sim_result.png"))
```

# Results

The result of running the simulations across all sites are given in Figure \@ref(fig:results). Overall, as is indicated by the measures for central tendency and the almost solid line along the 0 mark on the y-axes, most of the sites have been situated close to the shoreline when they were in use. When including all dates, also those that were believed to be erroneous in the original reports, some of the sites are situated considerable distances from the shoreline, as could be expected. To what degree these do in fact represent contamination is discussed further below. However, if one accepts the interpretation in the reports that these dates do not date the main occupation of the sites, the second row of Figure \@ref(fig:results) gives considerable support to the notion that the sites were in use when they were situated on or close to the contemporaneous shoreline. It is interesting to note the distance for some of the earliest sites, which appears somewhat high. This, however, can likely be explained as the result of the steepness of the displacement curves for the earliest part of the Holocene (Figure \@ref(fig:map-iso)B), which leads the uncertainty in the ^14^C-dates to give a wider possible elevation range for the sea-level. Another immediately striking result is the apparent deviation from the shoreline towards the end of the Stone Age. From around 2500 BCE several sites are situated a considerable distance from the shoreline, and while a couple remain horizontally and topographically close, they appear to be elevated a considerable distance from the sea-level, as indicated on the plot for vertical distance. This corresponds well with the literature, where the introduction of the Neolithic proper is seen as occurring around this time [@prescott2020; @solheim2021]. With the transition from a predominantly hunter-gatherer lifeway to early agro-pastoralism, settlements in coastal areas are to be increasingly withdrawn from the shoreline. 

The negative values around 8000 BCE originate from the sites Løvås 1, 2 and 3. These are recently excavated, well-dated sites situated in a relatively undistributed area of the landscape. Thus, while there is a danger of circularity of having archaeological sites inform a reconstruction of the shoreline displacement, and in turn use these to evaluate the degree of shore-bound settlement, the sites do clearly represent a upper limit as they would not have been in use when located beneath sea-level. Furthermore, as the Løvås sites are located at elevations from where the local displacement curve is interpolated between isololation basins at different elevation, it would seem that the sites represent a case where the archaeological material indicates discrepancies in the geological reconstructions of shoreline displacement in the area.

Accepting that shoreline dating appears to loose utility around the transition to the Late Neolithic, the results for the second row of Figure \@ref(fig:results) is given again in Figure \@ref(fig:results2), excluding all simulation results younger than 2500 BCE. Furthermore, all negative values have here been set to zero, under the assumption that these result from uncertainty or errors in the data, and not actual site locations. Following the general and aggregative result of this, one recommendation could be that given no other information, the method of shoreline dating should be applied with an uncertainty of 0-15m offset to the Stone Age site elevation relative to the displacement curves, following the median vertical distance and associated interquartile range. This would naturally be best applied when combined with a more comprehensive consideration of the site location, which could lead one to reduce this uncertainty, given for example surroundings where it would be reasonable to assume that a certain sea-levels would be unlikely in light of the surroundings of the site.  


```{r results, echo = FALSE, fig.cap = "The result of running the analysis across all sites. Each data point is plotted with some transparency, meaning that the darker the colour, the more often those values occured. The first row shows the result of including all dates the Stone Age, including those seen as otherwise  unrelated to the main occupation of the sites. The second row shows the result of excluding these. The table under each plot lists some corresponding statistics for central tendency and dispersion.", out.width = "500px", fig.align="center"}
knitr::include_graphics(here("analysis/figures/results.png"))

```

```{r results2, echo = FALSE, fig.cap = "Histograms showing distance from shoreline using only dates older than 2500 BCE that correspond to the site inventory.", out.width = "525px", fig.align="center"}
knitr::include_graphics(here("analysis/figures/results2.png"))
```

# Discussion

Some sources of likely variation and uncertainty have not been considered here. First of all the DTM has only been corrected for major modern disturbances. This means that erosion, although likely not that prevalent, has not been taken into account. Secondly, the DTM has a vertical error... Thirdly, the tidal range has not been considered...  Fourthly, the exposure of the sites to wave action is also likely to have been of concern, and will presumably have implications for how close to the shoreline people settled. And finally, the nature of the visits to the sites will presumably also have implications for how exposed a site. These dimensions will have implications for the shore-line dating for certain subsets of the sites and could be future avenues through which one could further improve the method. These dimensions will also be imprtant for more substantial considerations of the behavioural relation between sites and the shoreline. 

# Conclusion

The most immediate contribution of this paper is a confirmation of previous research into the relation between coastal Norwegian Stone Age sites and the prehistoric shoreline, which has largely been verified. Furthermore, the typical application of shoreline dating as an approximate method where date ranges are often for example rounded off to 200-year intervals, means that most previous research based on the method is given support by the findings reported here. However, the findings also suggest that simply using the method as a terminus ante quem for the occupation of the sites is, at least in my view, overly conservative and would stand to unnecessarily loose important chronological information. Attempting to move these considerations further through an explicit quantification has here resulted in a concrete recommendation of applying an offset of 0-15m when shoreline dating sites where no other information is available.

This quantification was achieved by means of Monte Carlo-simulation, integrating multiple sources of spatio-temporal uncertainty. Here the approach was simply used to inform the question of the distance between sites and shorelines. However, this method can be extended to a wide range of use-cases where one needs to visualise and quantitatively or qualitatively evaluate the relationship between archaeological phenomena, the prehistoric shore-line, and the uncertainty inherent in this reconstruction.

\newpage

# References

::: {#refs}
:::

<!-- \newpage -->

<!-- ### Colophon -->

<!-- This report was generated on `r Sys.time()` using the following computational environment and dependencies: -->

<!-- ```{r colophon, cache = FALSE} -->
<!-- # which R packages and versions? -->
<!-- if ("devtools" %in% installed.packages()) devtools::session_info() -->
<!-- ``` -->

<!-- The current Git commit details are: -->

<!-- ```{r} -->
<!-- # what commit is this file at?  -->
<!-- if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())   -->
<!-- ``` -->
